[![View English Version](https://img.shields.io/badge/-View%20English%20Version-8A2BE2?style=for-the-badge&logo=googletranslate&logoColor=white)](README.md)



# اجرای Ollama و n8n در Google Colab

این نوت‌بوک Google Colab به شما امکان می‌دهد تا Ollama (یک پلتفرم برای اجرای مدل‌های زبان بزرگ به صورت محلی) و n8n (یک ابزار اتوماسیون گردش کار) را در یک محیط Colab راه‌اندازی و اجرا کنید. داده‌های n8n برای پایداری در Google Drive ذخیره می‌شوند و از ngrok برای ایجاد یک تونل عمومی به سرویس n8n شما استفاده می‌شود.

## پیش‌نیازها

* یک حساب Google برای استفاده از Colab و Google Drive.
* یک توکن احراز هویت ngrok (می‌توانید آن را از [داشبورد ngrok](https://dashboard.ngrok.com/get-started/your-authtoken) دریافت کنید).

## ساختار نوت‌بوک و راهنمای استفاده

این نوت‌بوک به چندین بخش (سلول) تقسیم شده است. برای بهترین نتیجه، سلول‌ها را به ترتیب اجرا کنید.

###  بخش ۱: بررسی و راه‌اندازی GPU

* **عملکرد:** این سلول وضعیت GPU موجود در محیط Colab، نسخه CUDA و میزان حافظه آزاد سیستم را بررسی می‌کند.
    ```python
    !nvidia-smi
    !nvcc -V
    !free -h
    ```
* **نحوه استفاده:** این سلول را اجرا کنید تا مطمئن شوید که یک GPU به درستی تخصیص داده شده و قابل استفاده است، به خصوص اگر قصد دارید از مدل‌های بزرگتر Ollama استفاده کنید.

### بخش ۲: نصب Ollama

* **عملکرد:** این سلول Ollama را در محیط Colab نصب می‌کند.
    * بسته‌های سیستم را به‌روزرسانی می‌کند (`apt-get update`).
    * ابزارهای لازم مانند `curl` و `wget` را نصب می‌کند.
    * اسکریپت نصب رسمی Ollama را دانلود و اجرا می‌کند.
    * نسخه نصب شده Ollama را بررسی می‌کند.
    * یک پوشه موقت (`/tmp/ollama`) برای ذخیره مدل‌های Ollama ایجاد می‌کند (تا از پر شدن فضای ذخیره‌سازی اصلی Colab جلوگیری شود).
    ```python
    !apt-get update
    !apt-get install -y curl wget
    !curl -fsSL [https://ollama.com/install.sh](https://ollama.com/install.sh) | sh
    !ollama --version
    !mkdir -p /tmp/ollama
    ```
* **نحوه استفاده:** این سلول را برای نصب Ollama اجرا کنید.

### بخش ۳: اجرای سرویس Ollama

* **عملکرد:** این سلول سرویس Ollama را در پس‌زمینه راه‌اندازی می‌کند.
    * متغیر محیطی `OLLAMA_MODELS` را تنظیم می‌کند تا مدل‌ها در پوشه `/tmp/ollama` ذخیره شوند.
    * سرویس `ollama serve` را با استفاده از `subprocess` در پس‌زمینه اجرا می‌کند و لاگ‌ها را در `/tmp/ollama.log` ذخیره می‌کند.
    * چند ثانیه منتظر می‌ماند تا سرویس شروع به کار کند.
    * با اجرای دستور `ollama list` وضعیت سرویس را بررسی می‌کند و در صورت موفقیت، پیام تایید و چند خط آخر لاگ‌ها را نمایش می‌دهد.
    * شناسه فرآیند (PID) سرویس Ollama و آدرس دسترسی محلی (`http://127.0.0.1:11434`) را نمایش می‌دهد.
* **نحوه استفاده:** این سلول را برای شروع به کار سرویس Ollama اجرا کنید. پس از اجرای موفقیت‌آمیز، Ollama آماده دریافت درخواست‌ها در آدرس مشخص شده خواهد بود.

### بخش ۴: دانلود مدل‌های Ollama

* **عملکرد:** این سلول به شما امکان می‌دهد مدل‌های زبان بزرگ مختلفی را برای Ollama دانلود کنید.
    * لیستی از مدل‌های از پیش تعریف‌شده (مانند `llama3:8b`, `mistral:7b`, `phi3:mini`) با گزینه‌هایی برای انتخاب (True/False) ارائه می‌دهد.
    * به شما اجازه می‌دهد نام مدل‌های سفارشی را برای دانلود وارد کنید (مثلاً `vicuna:latest,orca-mini:3b`).
    * گزینه‌ای برای اجرای یک پرامپت آزمایشی بر روی مدل‌های دانلود شده دارد.
    * مدل‌های انتخاب شده را با استفاده از دستور `ollama pull {model_name}` دانلود می‌کند.
    * لیست تمام مدل‌های دانلود شده را با `ollama list` نمایش می‌دهد.
    * اگر گزینه پرامپت آزمایشی فعال باشد، پرامپت مشخص شده را روی هر مدل دانلود شده اجرا می‌کند، پاسخ و زمان پاسخ‌دهی را نمایش می‌دهد و نتایج را در یک فایل متنی ذخیره می‌کند.
* **نحوه استفاده:**
    1.  مدل یا مدل‌های مورد نظر خود را با تنظیم مقدار مربوطه روی `True` انتخاب کنید.
    2.  در صورت تمایل، نام مدل‌های سفارشی را در فیلد `custom_models` وارد کنید.
    3.  اگر می‌خواهید مدل‌ها را آزمایش کنید، `run_test_prompt` را روی `True` تنظیم کرده و یک `test_prompt` وارد کنید.
    4.  سلول را اجرا کنید. دانلود مدل‌ها بسته به اندازه و سرعت اینترنت ممکن است زمان‌بر باشد.

### بخش ۵: راه‌اندازی و اجرای n8n

* **عملکرد:** این سلول n8n را نصب، پیکربندی و اجرا می‌کند، آن را به Google Drive برای ذخیره‌سازی داده‌ها متصل کرده و از طریق ngrok یک URL عمومی برای دسترسی به آن ایجاد می‌کند.
    1.  **ورودی‌های کاربر:**
        * `NGROK_AUTH_TOKEN`: توکن احراز هویت ngrok شما. **این فیلد الزامی است.**
        * `gdrive_path`: نام پوشه‌ای که در Google Drive شما برای ذخیره داده‌های n8n ایجاد می‌شود (پیش‌فرض: `n8n_data`).
        * `N8N_BASIC_AUTH`: اگر روی `True` تنظیم شود، احراز هویت پایه برای n8n فعال می‌شود.
        * `N8N_USERNAME` و `N8N_PASSWORD`: نام کاربری و رمز عبور برای احراز هویت پایه n8n (در صورت فعال بودن).
    2.  **نصب بسته‌ها:** `pyngrok` را نصب می‌کند.
    3.  **اتصال به Google Drive:** به حساب Google Drive شما متصل می‌شود و پوشه مشخص شده (مثلاً `n8n_data`) را در مسیر `My Drive` ایجاد می‌کند (اگر وجود نداشته باشد). همچنین زیرپوشه‌های `data` و `database` را در آن ایجاد می‌کند.
    4.  **پیکربندی ngrok:** توکن ngrok شما را برای احراز هویت تنظیم می‌کند.
    5.  **بررسی و نصب Node.js:** نسخه Node.js را بررسی می‌کند و در صورت نیاز، نسخه ۱۸ (یا بالاتر سازگار) را نصب می‌کند، زیرا n8n به آن نیاز دارد.
    6.  **نصب n8n:** اگر n8n قبلاً نصب نشده باشد، آن را با استفاده از `npm` به صورت سراسری نصب می‌کند.
    7.  **ایجاد فایل پیکربندی n8n:** یک فایل `config.js` برای n8n ایجاد می‌کند که مسیر پایگاه داده SQLite را به پوشه `database` در Google Drive شما تنظیم می‌کند. در صورت فعال بودن `N8N_BASIC_AUTH`، تنظیمات احراز هویت را نیز اضافه می‌کند.
    8.  **ایجاد لینک سمبولیک:** یک لینک سمبولیک از فایل پیکربندی ایجاد شده به مسیر پیش‌فرض پیکربندی n8n (`~/.n8n/config.js`) ایجاد می‌کند.
    9.  **راه‌اندازی تونل ngrok:** یک تونل ngrok برای پورت محلی `5678` (پورت پیش‌فرض n8n) ایجاد می‌کند و URL عمومی ایجاد شده را نمایش می‌دهد.
    10. **تنظیم متغیرهای محیطی برای n8n:** متغیرهای محیطی لازم برای اجرای n8n، از جمله `WEBHOOK_URL` با استفاده از URL عمومی ngrok را تنظیم می‌کند.
    11. **راه‌اندازی n8n:** سرویس n8n را در پس‌زمینه با استفاده از `nohup n8n start` اجرا می‌کند. لاگ‌های n8n در فایلی به نام `n8n.log` در پوشه `gdrive_path` شما در Google Drive ذخیره می‌شوند.
    12. **نمایش اطلاعات دسترسی:** URL عمومی n8n (از طریق ngrok) و اطلاعات ورود (در صورت فعال بودن احراز هویت پایه) را نمایش می‌دهد.
    13. **دستورالعمل‌های استفاده:** نکاتی در مورد نحوه استفاده از مدل‌های Ollama در n8n (با استفاده از گره HTTP Request و آدرس API محلی Ollama: `http://localhost:11434/api/generate`) ارائه می‌دهد.
    14. **نمایش n8n در IFrame:** رابط کاربری n8n را مستقیماً در خروجی سلول Colab در یک IFrame نمایش می‌دهد.
    15. **تابع مشاهده لاگ‌ها:** یک تابع پایتون به نام `view_logs()` تعریف می‌کند که با فراخوانی آن می‌توانید ۲۰ خط آخر لاگ‌های n8n و Ollama را مشاهده کنید.
* **نحوه استفاده:**
    1.  توکن احراز هویت `NGROK_AUTH_TOKEN` خود را در فیلد مربوطه وارد کنید.
    2.  در صورت تمایل، نام پوشه `gdrive_path` و تنظیمات احراز هویت n8n را تغییر دهید.
    3.  سلول را اجرا کنید. این سلول ممکن است مدتی طول بکشد تا تمام مراحل نصب و راه‌اندازی را انجام دهد.
    4.  پس از اجرای موفقیت‌آمیز، URL عمومی n8n نمایش داده می‌شود. می‌توانید از این URL برای دسترسی به رابط کاربری n8n در مرورگر خود استفاده کنید یا مستقیماً از IFrame در خروجی سلول استفاده کنید.
    5.  برای استفاده از Ollama در گردش کار n8n، از گره `HTTP Request` استفاده کنید و درخواست‌های POST را به آدرس `http://localhost:11434/api/generate` با بدنه JSON مناسب ارسال کنید (مثلاً `{"model": "your-model-name", "prompt": "your-prompt"}`).

## نکات مهم

* **فعال نگه داشتن نوت‌بوک:** برای اینکه سرویس‌های Ollama و n8n (و تونل ngrok) فعال باقی بمانند، باید این نوت‌بوک Colab باز و در حال اجرا باشد. اگر نوت‌بوک بسته شود یا زمان اجرای آن در Colab به پایان برسد، سرویس‌ها متوقف خواهند شد.
* **محدودیت‌های Colab:** Google Colab محدودیت‌هایی برای مدت زمان اجرای نوت‌بوک‌ها و استفاده از منابع دارد. برای استفاده طولانی‌مدت و بدون وقفه، راه‌حل‌های دیگری مانند اجرای این سرویس‌ها بر روی یک سرور شخصی یا VPS را در نظر بگیرید.
* **امنیت:** توکن ngrok شما حساس است. آن را با دیگران به اشتراک نگذارید. اگر از احراز هویت پایه برای n8n استفاده می‌کنید، از یک رمز عبور قوی استفاده کنید.
* **فضای ذخیره‌سازی:** مدل‌های زبان بزرگ می‌توانند فضای زیادی را اشغال کنند. مطمئن شوید که فضای کافی در Google Drive (برای داده‌های n8n) و در محیط موقت Colab (برای مدل‌های Ollama) دارید. مدل‌های Ollama پس از بسته شدن جلسه Colab از پوشه `/tmp/ollama` حذف خواهند شد و در اجرای بعدی باید مجدداً دانلود شوند، مگر اینکه راهکاری برای ذخیره دائمی آن‌ها در Google Drive پیاده‌سازی کنید (که در این نوت‌بوک پوشش داده نشده است).

## عیب‌یابی

* **خطا در راه‌اندازی Ollama:** لاگ‌های Ollama را در `/tmp/ollama.log` بررسی کنید.
* **خطا در راه‌اندازی n8n:** لاگ‌های n8n را در پوشه `gdrive_path` خود در Google Drive (فایل `n8n.log`) بررسی کنید. می‌توانید از تابع `view_logs()` در آخرین سلول نیز استفاده کنید.
* **مشکل در اتصال ngrok:** مطمئن شوید که توکن ngrok شما معتبر و به درستی وارد شده است. وضعیت سرویس ngrok را در داشبورد ngrok خود بررسی کنید.
* **مدل Ollama یافت نشد:** مطمئن شوید که مدل مورد نظر را با موفقیت در بخش ۴ دانلود کرده‌اید و نام آن را به درستی در درخواست‌های API خود استفاده می‌کنید. با اجرای `!ollama list` در یک سلول جدید می‌توانید لیست مدل‌های موجود را ببینید.

---

این README با هدف ارائه یک راهنمای جامع برای استفاده از نوت‌بوک شما ایجاد شده است. در صورت نیاز می‌توانید آن را ویرایش و تکمیل کنید.
